<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"
    />
    <link rel="stylesheet" href="team/css/style.css" />
    <link rel="stylesheet" href="team/font/iconfont.css" />
    <script src="team/js/message.js"></script>
    <title>邀请好友</title>
    <style>
      body {
        -webkit-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
        -moz-text-size-adjust: 100% !important;
      }
    </style>
  </head>

  <body>
    <div class="box_container">
      <div class="collage_title" id="ClickMe">邀请规则</div>
      <div class="icon1_box"></div>
      <div class="icon_title">
        <image src="team/image/yinghaoli.png" />
      </div>
      <div class="invitation_team">
        <div class="invitation_team_title">
          <p>邀请好友</p>
        </div>
        <div class="count_down">
          <b style="color: #333333">组队倒计时</b>
          <b style="color: #df4a30"
            ><span class="hours">00</span>:<span class="minutes">00</span>:<span class="seconds"
              >00</span
            ></b
          >
        </div>
        <div class="count_head_portrait">
          <div class="count_head_portrait_team">
            <img src="team/image/add.png" alt="" />
          </div>
          <div class="count_head_portrait_team">
            <img src="team/image/add.png" alt="" />
          </div>
          <div class="count_head_portrait_team">
            <img src="team/image/add.png" alt="" />
          </div>
          <p>还需邀请<b>2</b>位好友助力</p>
        </div>
        <div class="invitation_team_button">
          <button id="confirm">加入队伍</button>
          <button id="kaituan">我要开团</button>
        </div>
      </div>
      <div class="invitation_ranking">
        <div class="invitation_team_title">
          <p>团队运动排名</p>
        </div>
        <div class="invitation_ranking_title">
          <table id="rank">
            <tr>
              <th>名次</th>
              <th>用户</th>
              <th>蹦跳次数</th>
            </tr>
          </table>
        </div>
      </div>
      <div class="invitation_erweima" id="invitation_erweima">
        <div class="invitation_team_title">
          <p>邀请方式</p>
        </div>
        <div class="invitation_erweima_img">
          <!-- <image id="qrcode" src="" /> -->
          <div id="qrcode"></div>
        </div>
        <div class="invitation_erweima_zhuanfa">
          <p>右上角转发此链接或扫码邀请</p>
          <button
            id="fenxiang_btn"
            data-ydui-actionsheet="{target:'#actionSheet',closeElement:'#cancel'}"
          >
            分享有礼
          </button>
        </div>
      </div>
    </div>

    <div class="m-actionsheet" id="actionSheet">
      <div class="jq22-show-box">
        <div class="jq22-show-box-title jq22-footer-flex">
          <div class="b-line jq22-coll-share-box">
            <a href=" " class="jq22-coll-share-item">
              <div class="jq22-coll-share-img">
                <img src="team/image/icon-wx.png" alt="" />
              </div>
              <div class="jq22-coll-share-text">微信好友</div>
            </a>
            <a href="javascript:;" class="jq22-coll-share-item">
              <div class="jq22-coll-share-img">
                <img src="team/image/icon-pyq.png" alt="" />
              </div>
              <div class="jq22-coll-share-text">朋友圈</div>
            </a>
            <a href="javascript:;" class="jq22-coll-share-item" id="17hai_icon">
              <div class="jq22-coll-share-img">
                <img src="team/image/icon-17hai.png" alt="" />
              </div>
              <div class="jq22-coll-share-text">17嗨</div>
            </a>
          </div>
          <div class="jq22-coll-cancel">
            <a href="javascript:;" id="cancel" class="">取消 </a>
          </div>
        </div>
      </div>
    </div>
    <div class="" id="goodcover"></div>
    <div class="" id="code">
      <img class="code_img_guize" src="team/image/guize.png" alt="" />
      <div class="close1"><a href="javascript:void(0)" id="closebt"></a></div>
      <div class="jq22-code-text">
        <p style="text-align: center; font-weight: 700; font-size: 0.5rem; margin-top: 0.4rem">
          活动玩法
        </p>
        <p>
          <span
            class="yuan_box"
            style="
              text-align: center;
              font-size: 0.4rem;
              border-radius: 10rem;
              background-color: #f7cc7d;
              color: #c6212a;
              font-weight: 700;
              display: inline-block;
              width: 0.6rem;
              height: 0.6rem;
              margin-right: 0.2rem;
              line-height: 0.6rem;
            "
            >1</span
          >活动时间：2021年10月13日-2022年10月13日
        </p>
        <p>
          <span class="yuan_box">2</span>活动期间，用户可以在17嗨App平台组队打卡页面参与组队
          打卡赢积分赢好礼活动。
        </p>
        <p><span class="yuan_box">3</span>3人组队参与活动，可以通过分享链接二维码或面对面邀请。</p>
        <p><span class="yuan_box">4</span>根据团队运动排名瓜分积分好礼。</p>
        <p><span class="yuan_box">5</span>中奖后请主动添加微信客服获得奖励，否则视为弃权。</p>
        <p style="text-align: center; font-weight: 700; font-size: 0.5rem">组队规则</p>
        <p><span class="yuan_box">1</span>每个用户邀请两个好友组成一个队伍参与活动。</p>
        <p><span class="yuan_box">2</span>如发现有恶意刷的行为，17嗨有权不发放或撤回发放的奖品。</p>
        <p><span class="yuan_box">3</span>此活动最终解释权归17嗨所有。</p>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="team/js/myTool.js"></script>
    <script type="text/javascript" src="team/js/layer.js"></script>
    <script src="team/js/rem.js"></script>
    <script src="team/js/qrcode.min.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <!-- <script src="js/vconsole.min.js"></script> -->
    <script>
      (function () {
        if (typeof WeixinJSBridge == 'object' && typeof WeixinJSBridge.invoke == 'function') {
          handleFontSize();
        } else {
          if (document.addEventListener) {
            document.addEventListener('WeixinJSBridgeReady', handleFontSize, false);
          } else if (document.attachEvent) {
            document.attachEvent('WeixinJSBridgeReady', handleFontSize);
            document.attachEvent('onWeixinJSBridgeReady', handleFontSize);
          }
        }
        function handleFontSize() {
          WeixinJSBridge.invoke('setFontSizeCallback', { fontSize: 0 });
          WeixinJSBridge.on('menu:setfont', function () {
            WeixinJSBridge.invoke('setFontSizeCallback', { fontSize: 0 });
          });
        }
      })();
    </script>
    <script>
      const gettime = (data) => {
        var hours = parseInt((data % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = parseInt((data % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = (data % (1000 * 60)) / 1000;
        return { hours, minutes, seconds };
      };
      // 获取url参数
      const getUrlParams = () => {
        let url = location.search; //获取url中"?"符后的字串
        // console.log(url)
        let theRequest = new Object();
        if (url.indexOf('?') !== -1) {
          let str = url.substr(1);
          let strs = str.split('&');
          for (let i = 0; i < strs.length; i++) {
            theRequest[strs[i].split('=')[0]] = decodeURIComponent(strs[i].split('=')[1]);
          }
        }
        return theRequest;
      }; // 二维码
      var qrcode = new QRCode(document.getElementById('qrcode'), {
        width: 150,
        height: 150,
      });
      var elText = document.getElementById('qrcode');
      qrcode.makeCode(location.href);
      console.log(location.href);
      const query = getUrlParams();

      // ===== 获取组队信息 =====
      function getGroupInfoData() {
        let groupInfoParams = {};
        // 微信
        if (query.code) {
          if (window.openId) {
            groupInfoParams = {
              groupId: query.groupId,
              nickName: query.nickName,
              avatarUrl: query.avatarUrl,
            };
          } else {
            groupInfoParams = {
              code: query.code,
              state: query.groupId,
              nickName: query.nickName,
              avatarUrl: query.avatarUrl,
            };
          }
        } else {
          groupInfoParams = {
            userId: query.userId,
            groupId: query.groupId,
            nickName: query.nickName,
            avatarUrl: query.avatarUrl,
          };
        }
        mu.get('/mgmt/group/info', groupInfoParams, function (res) {
          const {
            userId,
            userGroups,
            initTime,
            groupId,
            openId,
            userRank,
            expired,
            nickName,
            avatarUrl,
          } = res.data;
          window.openId = openId;
          // 微信
          if (query.code) {
            document.getElementById('kaituan').style.display = 'none';
            document.getElementsByClassName('invitation_team_button')[0].style.width = 'auto';
            document.getElementById('confirm').style.width = '100%';
          } else {
            if (query.userId == userGroups[0].userId) {
              document.getElementById('kaituan').style.display = 'none';
              document.getElementsByClassName('invitation_team')[0].style.height = '6.2rem';
              document.getElementById('confirm').style.display = 'none';
              //给App传参数
              let u = navigator.userAgent;
              let isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //g
              let isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
              if (isAndroid) {
                window.jionTeamJsAgent.setGroupId(groupId);
              }
              if (isIOS) {
                window.webkit.messageHandlers.setGroupId.postMessage(groupId);
              }
            }
          }
          //给App传参数
          // let group=1114;

          // 组员名单处理
          const html = [];
          for (let i = 0; i < 3; i++) {
            if (userGroups[i]) {
              html.push(`<div class="count_head_portrait_team">
            <img src="${userGroups[i].avatarUrl}" alt="" onerror="onerror=null;src='team/image/kong.jpg'"/>
            </div>`);
            } else {
              html.push(`<div class="count_head_portrait_team">
            <img src="team/image/add.png" alt="" />
            </div>`);
            }
          }
          html.push(`<p>还需邀请<b>${3 - userGroups.length}</b>位好友助力</p >`);
          $('.count_head_portrait')[0].innerHTML = html.join('');
          // 队伍排名处理
          const html2 = [
            `<tr>
              <th>名次</th>
              <th>用户</th>
              <th>蹦跳次数</th>
            </tr>`,
          ];
          for (let i = 0; i < userRank.length; i++) {
            html2.push(`<tr>
              <td><b>${i + 1}</b></td>
              <td>${userRank[i].nickName}</td>
              <td>${userRank[i].value}</td>
            </tr>`);
            html2.push(`<tr>
              <td>
                <div class="line"></div>
              </td>
              <td>
                <div class="line"></div>
              </td>
              <td>
                <div class="line"></div>
              </td>
            </tr>`);
          }
          html2.pop();

          $('#rank')[0].innerHTML = html2.join('');
          // 倒计时处理
          const inittime = Date.parse(new Date(initTime.replace(/-/g, '/')));
          const total = 24 * 60 * 60 * 1000;
          const hourstarget = $('.hours')[0];
          const minutestarget = $('.minutes')[0];
          const seconedtarget = $('.seconds')[0];
          const timer = setInterval(() => {
            const nowtime = Date.parse(new Date());
            const time = nowtime - inittime;
            let timetext;
            let onlytime = total - time;
            if (onlytime < 0) {
              timetext = { hours: 0, minutes: 0, seconds: 0 };
            } else {
              timetext = gettime(onlytime);
            }
            hourstarget.innerHTML = timetext.hours < 10 ? '0' + timetext.hours : timetext.hours;
            minutestarget.innerHTML =
              timetext.minutes < 10 ? '0' + timetext.minutes : timetext.minutes;
            seconedtarget.innerHTML =
              timetext.seconds < 10 ? '0' + timetext.seconds : timetext.seconds;
          }, 1000);
          //   ===== 加入队伍处理
          const handleClickConfirm = () => {
            let groupJoinParams = {};
            // 微信
            if (query.code) {
              groupJoinParams = {
                nickName,
                avatarUrl,
                openId,
                groupId: query.groupId,
              };
            } else {
              groupJoinParams = {
                userId: query.userId,
                groupId: query.groupId,
                nickName: query.nickName,
                avatarUrl: query.avatarUrl,
              };
            }
            mu.get('/mgmt/group/join', groupJoinParams, function (res) {
              debugger;
              if (res.code == 10000) {
                confirm(res.message).then(() => {
                  console.log('确定');
                  getGroupInfoData();
                });
              } else {
                confirm(res.message);
              }
            });
          };
          document.getElementById('confirm').removeEventListener('click', handleClickConfirm);
          document.getElementById('confirm').addEventListener('click', handleClickConfirm);
          // ===== 开团处理
          const handleClickKaituan = () => {
            location.href = location.origin + location.pathname + '?userId=' + query.userId;
          };
          document.getElementById('kaituan').removeEventListener('click', handleClickKaituan);
          document.getElementById('kaituan').addEventListener('click', handleClickKaituan);
          // 过期处理
          if (expired !== 'false') {
            confirm('队伍已过期');
          }
        });
      }
      getGroupInfoData();
      // 判断是否微信
      var ua = navigator.userAgent.toLowerCase();
      var hai_icon = document.getElementById('17hai_icon');
      var confirm_btn = document.getElementById('confirm');
      var kaituan = document.getElementById('kaituan');
      var fenxiang_btn = document.getElementById('fenxiang_btn');
      var invitation_erweima = document.getElementById('invitation_erweima');
      if (ua.match(/MicroMessenger/i) == 'micromessenger' && !query.code) {
        //微信授权登录
        // console.log('href', window.location.href)
        let url = 'http://qdss.triplemaster.com/team';
        if (query.groupId) url = `${url}?groupId=${query.groupId}`;
        const URL = encodeURIComponent(url);
        login('wx1be1459b4f91f18f', URL);
        function login(appid, url) {
          var toUrl =
            'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' +
            appid +
            '&redirect_uri=' +
            url +
            '&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';
          window.location.replace(toUrl);
        }
        hai_icon.style.display = 'none';
        confirm_btn.style.background = '#5AC58B';
        confirm_btn.style.width = '100%';
        kaituan.style.display = 'none';
        fenxiang_btn.style.display = 'block';
        invitation_erweima.style.height = '9.2rem';
      }

      // 分享按钮
      var fenxiangurl = location.href;
      var timestamp = '';
      var signature = '';
      var title = document.title;
      var shareData = {
        imgUrl: 'http://thirdqq.qlogo.cn/g?b=oidb&k=mc9iaETfGiaicIGv0ozKh87Dw&s=640&t=1556703632',
        link: fenxiangurl,
        desc: '邀请好友进入拼团',
        title: title,
        success: function () {
          alert('分享成功');
        },
      };
      function init() {
        var parms = {
          fenxiangurl: fenxiangurl,
          signature: signature,
          timestamp: timestamp,
        };
        $.ajax({
          type: 'get',
          url: 'http://qdss.triplemaster.com',
          dataType: 'json',
          success: function (data) {
            timestamp = data.timestamp;
            signature = data.signature;
            nonceStr = data.nonceStr;
            initwx(timestamp, signature);
          },
        });
      }
      $(function () {
        init();
      });
      function initwx(timestamp, nonceStr, signature) {
        wx.config({
          debug: false,
          appId: 'wx1be1459b4f91f18f', // 公众号的唯一标识
          timestamp: timestamp, //生成签名的时间戳
          nonceStr: nonceStr, //生成签名的随机串
          signature: signature, //
          jsApiList: [
            'onMenuShareTimeline', //
            'onMenuShareAppMessage',
          ], //
        });
        wx.checkJsApi({
          jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage'],
        });
        wx.ready(function () {
          wx.onMenuShareTimeline(shareData); //分享到朋友圈
          wx.onMenuShareAppMessage(shareData); //分享给朋友
        });
      }
    </script>
  </body>
</html>
